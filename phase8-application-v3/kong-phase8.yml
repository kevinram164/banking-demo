# Kong config cho Phase 8 — /api → api-producer (ns banking)
# Áp dụng lên Kong trong ns kong (Kong nhận traffic từ ingress npd-banking.co)
#
# Cách apply (Admin API):
#   kubectl port-forward -n kong svc/kong-kong-admin 8001:8001
#   curl -s -X POST http://localhost:8001/config \
#     -F "config=@kong-phase8.yml" \
#     -H "Content-Type: multipart/form-data"
#
# Hoặc dùng decK / kong declarative config tùy cách Kong được deploy.

_format_version: "3.0"
_transform: true

services:
  # Phase 8: Tất cả /api/* → api-producer (RabbitMQ → consumers)
  - name: api-producer
    url: http://api-producer.banking.svc.cluster.local:8080
    routes:
      - name: api-route
        paths:
          - /api
        strip_path: false
    plugins:
      - name: cors
        config:
          origins:
            - http://localhost:3000
            - https://npd-banking.co
            - http://npd-banking.co
          credentials: true
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - X-Session

  # /ws → notification-service (WebSocket, bypass queue)
  - name: notification-service
    url: http://notification-service.banking.svc.cluster.local:8004
    routes:
      - name: notification-ws-route
        paths:
          - /ws
        protocols:
          - http
          - https
        strip_path: false
    plugins:
      - name: cors
        config:
          origins:
            - http://localhost:3000
            - https://npd-banking.co
            - http://npd-banking.co
          credentials: true
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - X-Session
