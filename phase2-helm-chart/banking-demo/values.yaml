# Banking Demo - Parent values. Mặc định đủ để render toàn bộ.
# Mỗi service có Chart.yaml + values.yaml trong charts/<name>/; override bằng -f charts/<name>/values.yaml

global:
  namespace: banking
  secretName: banking-db-secret
  corsOrigins: "http://localhost:3000"
  imagePullSecrets:
    dockerhub: dockerhub-registry
    gitlab: gitlab-registry

namespace:
  enabled: true

secret:
  enabled: true
  postgresUser: banking
  postgresPassword: bankingpass
  postgresDb: banking
  databaseUrl: "postgresql://banking:bankingpass@postgres:5432/banking"
  redisUrl: "redis://redis:6379/0"

# --- Cấu hình đầy đủ từng service (có thể override bằng -f charts/<name>/values.yaml) ---
postgres:
  enabled: true
  fullnameOverride: postgres
  image:
    repository: postgres
    tag: "16"
    pullPolicy: IfNotPresent
  imagePullSecrets:
    - name: dockerhub-registry
  replicas: 1
  service:
    port: 5432
    portName: postgres
    clusterIP: None
  secretRef:
    name: banking-db-secret
    keys:
      user: POSTGRES_USER
      password: POSTGRES_PASSWORD
      db: POSTGRES_DB
  storage:
    storageClassName: nfs-client
    size: 1Gi
    volumeName: pgdata
    mountPath: /var/lib/postgresql/data
  readinessProbe:
    enabled: true
    user: banking
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 5
  resources:
    requests: { memory: "256Mi", cpu: "100m" }
    limits:   { memory: "512Mi", cpu: "500m" }
  securityContext:
    pod:
      seccompProfile: { type: RuntimeDefault }
      fsGroup: 999
    container:
      allowPrivilegeEscalation: false
  hook:
    preInstall: true
    preUpgrade: true
    weight: "-5"

redis:
  enabled: true
  fullnameOverride: redis
  image:
    repository: redis
    tag: 7-alpine
    pullPolicy: IfNotPresent
  imagePullSecrets:
    - name: dockerhub-registry
  replicas: 1
  service:
    port: 6379
    portName: redis
    clusterIP: None
  storage:
    storageClassName: nfs-client
    size: 256Mi
    volumeName: redis-data
    mountPath: /data
  readinessProbe:
    enabled: true
    command: ["redis-cli", "ping"]
    initialDelaySeconds: 3
    periodSeconds: 10
    timeoutSeconds: 1
  resources:
    requests: { memory: "64Mi", cpu: "50m" }
    limits:   { memory: "128Mi", cpu: "200m" }
  securityContext:
    pod:
      seccompProfile: { type: RuntimeDefault }
      fsGroup: 999
    container:
      allowPrivilegeEscalation: false
  hook:
    preInstall: true
    preUpgrade: true
    weight: "-5"

kong:
  enabled: true
  fullnameOverride: kong
  configMapName: kong-config
  configFileName: kong.yml
  configMountPath: /kong
  image:
    repository: kong
    tag: "3.4"
    pullPolicy: IfNotPresent
  imagePullSecrets:
    - name: dockerhub-registry
  replicas: 1
  proxyPort: 8000
  adminPort: 8001
  proxyPortName: proxy
  adminPortName: admin
  env:
    KONG_DATABASE: "off"
    KONG_DECLARATIVE_CONFIG: "/kong/kong.yml"
    KONG_PROXY_ACCESS_LOG: "/dev/stdout"
    KONG_ADMIN_ACCESS_LOG: "/dev/stdout"
    KONG_PROXY_ERROR_LOG: "/dev/stderr"
    KONG_ADMIN_ERROR_LOG: "/dev/stderr"
    KONG_ADMIN_LISTEN: "0.0.0.0:8001"
    KONG_PROXY_LISTEN: "0.0.0.0:8000"
    KONG_NGINX_WORKER_PROCESSES: "1"
  backends:
    - name: auth-service
      url: "http://auth-service:8001"
      routes:
        - name: auth-route
          paths: ["/api/auth"]
          strip_path: true
    - name: account-service
      url: "http://account-service:8002"
      routes:
        - name: account-route
          paths: ["/api/account"]
          strip_path: true
    - name: transfer-service
      url: "http://transfer-service:8003"
      routes:
        - name: transfer-route
          paths: ["/api/transfer"]
          strip_path: true
    - name: notification-service
      url: "http://notification-service:8004"
      routes:
        - name: notification-route
          paths: ["/api/notifications"]
          strip_path: true
        - name: notification-ws-route
          paths: ["/ws"]
          strip_path: false
          protocols: ["http", "https"]
  corsOrigins: "http://localhost:3000"
  corsCredentials: true
  corsMethods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
  corsHeaders:
    - Accept
    - Accept-Version
    - Content-Length
    - Content-MD5
    - Content-Type
    - Date
    - X-Session
  readinessProbe:
    enabled: true
    command: ["kong", "health"]
    initialDelaySeconds: 15
    periodSeconds: 10
    timeoutSeconds: 10
  resources:
    requests: { memory: "512Mi", cpu: "200m" }
    limits:   { memory: "1Gi", cpu: "1000m" }
  securityContext:
    pod:
      seccompProfile: { type: RuntimeDefault }
    container:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]

auth-service:
  enabled: true
  fullnameOverride: auth-service
  image:
    repository: registry.gitlab.com/kiettt164/banking-demo-payment/auth-service
    tag: v1
    pullPolicy: Always
  imagePullSecrets:
    - name: gitlab-registry
  replicas: 1
  service:
    port: 8001
    portName: http
  secretRef:
    name: banking-db-secret
    keys:
      databaseUrl: DATABASE_URL
      redisUrl: REDIS_URL
  corsOrigins: "http://localhost:3000"
  extraEnv:
    SESSION_TTL_SECONDS: "86400"
  readinessProbe:
    enabled: true
    path: /health
    port: 8001
    initialDelaySeconds: 10
    periodSeconds: 15
    timeoutSeconds: 1
  resources:
    requests: { memory: "128Mi", cpu: "100m" }
    limits:   { memory: "256Mi", cpu: "300m" }
  securityContext:
    pod:
      seccompProfile: { type: RuntimeDefault }
    container:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]

account-service:
  enabled: true
  fullnameOverride: account-service
  image:
    repository: registry.gitlab.com/kiettt164/banking-demo-payment/account-service
    tag: v1
    pullPolicy: Always
  imagePullSecrets:
    - name: gitlab-registry
  replicas: 1
  service:
    port: 8002
    portName: http
  secretRef:
    name: banking-db-secret
    keys:
      databaseUrl: DATABASE_URL
      redisUrl: REDIS_URL
  corsOrigins: "http://localhost:3000"
  extraEnv: {}
  readinessProbe:
    enabled: true
    path: /health
    port: 8002
    initialDelaySeconds: 10
    periodSeconds: 15
    timeoutSeconds: 1
  resources:
    requests: { memory: "128Mi", cpu: "100m" }
    limits:   { memory: "256Mi", cpu: "300m" }
  securityContext:
    pod:
      seccompProfile: { type: RuntimeDefault }
    container:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]

transfer-service:
  enabled: true
  fullnameOverride: transfer-service
  image:
    repository: registry.gitlab.com/kiettt164/banking-demo-payment/transfer-service
    tag: latest
    pullPolicy: Always
  imagePullSecrets:
    - name: gitlab-registry
  replicas: 1
  service:
    port: 8003
    portName: http
  secretRef:
    name: banking-db-secret
    keys:
      databaseUrl: DATABASE_URL
      redisUrl: REDIS_URL
  corsOrigins: "http://localhost:3000"
  extraEnv: {}
  readinessProbe:
    enabled: true
    path: /health
    port: 8003
    initialDelaySeconds: 10
    periodSeconds: 15
    timeoutSeconds: 1
  resources:
    requests: { memory: "128Mi", cpu: "100m" }
    limits:   { memory: "256Mi", cpu: "300m" }
  securityContext:
    pod:
      seccompProfile: { type: RuntimeDefault }
    container:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]

notification-service:
  enabled: true
  fullnameOverride: notification-service
  image:
    repository: registry.gitlab.com/kiettt164/banking-demo-payment/notification-service
    tag: latest
    pullPolicy: Always
  imagePullSecrets:
    - name: gitlab-registry
  replicas: 1
  service:
    port: 8004
    portName: http
  secretRef:
    name: banking-db-secret
    keys:
      databaseUrl: DATABASE_URL
      redisUrl: REDIS_URL
  corsOrigins: "http://localhost:3000"
  extraEnv: {}
  readinessProbe:
    enabled: true
    path: /health
    port: 8004
    initialDelaySeconds: 10
    periodSeconds: 15
    timeoutSeconds: 1
  resources:
    requests: { memory: "128Mi", cpu: "100m" }
    limits:   { memory: "256Mi", cpu: "300m" }
  securityContext:
    pod:
      seccompProfile: { type: RuntimeDefault }
    container:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]

frontend:
  enabled: true
  fullnameOverride: frontend
  image:
    repository: registry.gitlab.com/kiettt164/banking-demo-payment/frontend
    tag: v1
    pullPolicy: IfNotPresent
  imagePullSecrets: []
  replicas: 1
  service:
    port: 80
    portName: http
  readinessProbe:
    enabled: true
    path: /
    port: 80
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 1
  resources:
    requests: { memory: "64Mi", cpu: "50m" }
    limits:   { memory: "128Mi", cpu: "200m" }
  securityContext:
    pod:
      seccompProfile: { type: RuntimeDefault }
    container:
      allowPrivilegeEscalation: false

ingress:
  enabled: true
  className: haproxy
  host: npd-banking.co
  name: banking-ingress
  paths:
    - path: /
      pathType: Prefix
      serviceName: frontend
      servicePort: 80
    - path: /api
      pathType: Prefix
      serviceName: kong
      servicePort: 8000
    - path: /ws
      pathType: Prefix
      serviceName: kong
      servicePort: 8000
