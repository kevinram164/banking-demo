# ArgoCD/Helm merge theo key kong
kong:
  fullnameOverride: kong
  enabled: true
  image:
    repository: kong
    tag: "3.4"
    pullPolicy: IfNotPresent
  imagePullSecrets: []
  replicas: 1
  proxyPort: 8000
  adminPort: 8001
  proxyPortName: proxy
  adminPortName: admin
  configMountPath: /kong
  configFileName: kong.yml
  configMapName: kong-config
  env:
    KONG_DATABASE: "off"
    KONG_DECLARATIVE_CONFIG: "/kong/kong.yml"
    KONG_PROXY_ACCESS_LOG: "/dev/stdout"
    KONG_ADMIN_ACCESS_LOG: "/dev/stdout"
    KONG_PROXY_ERROR_LOG: "/dev/stderr"
    KONG_ADMIN_ERROR_LOG: "/dev/stderr"
    KONG_ADMIN_LISTEN: "0.0.0.0:8001"
    KONG_PROXY_LISTEN: "0.0.0.0:8000"
    KONG_NGINX_WORKER_PROCESSES: "1"
  backends:
    - name: auth-service
      url: "http://auth-service:8001"
      routes:
        - name: auth-route
          paths: ["/api/auth"]
          strip_path: true
    - name: account-service
      url: "http://account-service:8002"
      routes:
        - name: account-route
          paths: ["/api/account"]
          strip_path: true
    - name: transfer-service
      url: "http://transfer-service:8003"
      routes:
        - name: transfer-route
          paths: ["/api/transfer"]
          strip_path: true
    - name: notification-service
      url: "http://notification-service:8004"
      routes:
        - name: notification-route
          paths: ["/api/notifications"]
          strip_path: true
        - name: notification-ws-route
          paths: ["/ws"]
          strip_path: false
          protocols: ["http", "https"]
  # Cho phép CORS từ localhost và host production → tránh 403 trên WebSocket /ws
  corsOrigins:
    - "http://localhost:3000"
    - "https://npd-banking.co"
    - "http://npd-banking.co"
  corsCredentials: true
  corsMethods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
  corsHeaders:
    - Accept
    - Accept-Version
    - Content-Length
    - Content-MD5
    - Content-Type
    - Date
    - X-Session

  # Global plugins (ví dụ: prometheus cho monitoring)
  globalPlugins:
    - name: prometheus

  # Extra plugins applied per-service (in addition to cors).
  # Common choices for real-world:
  # - rate-limiting
  # - request-size-limiting
  # - correlation-id
  extraPlugins: []

  # Example (enable by copying into values):
  # extraPlugins:
  #   - name: rate-limiting
  #     config:
  #       minute: 300
  #       policy: local
  #   - name: request-size-limiting
  #     config:
  #       allowed_payload_size: 10  # MB
  readinessProbe:
    enabled: true
    command: ["kong", "health"]
    initialDelaySeconds: 15
    periodSeconds: 10
    timeoutSeconds: 10
  resources:
    requests:
      memory: "512Mi"
      cpu: "200m"
    limits:
      memory: "1Gi"
      cpu: "1000m"
  securityContext:
    pod:
      seccompProfile:
        type: RuntimeDefault
    container:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
