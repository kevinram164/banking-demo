# ApplicationSet: deploy RIÊNG TỪNG phần (infra, kong, auth-service, …) — mỗi phần một Application.
# Cùng chart, cùng path; mỗi app có releaseName và valueFiles khác nhau.
#
# Thứ tự deploy đề xuất: infra → kong → auth → account → transfer → notification → frontend → ingress.
# Áp dụng: kubectl apply -f application-set-per-service.yaml -n argocd
# Trước khi apply: sửa repoURL và targetRevision trong template; áp dụng project.yaml và sửa sourceRepos cho khớp.
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: banking-demo-per-service
  namespace: argocd
spec:
  generators:
    - list:
        elements:
          - release: banking-demo-infra
            valueFile: values-infra-only.yaml
          - release: banking-demo-kong
            valueFile: values-kong-only.yaml
          - release: banking-demo-auth
            valueFile: values-auth-only.yaml
          - release: banking-demo-account
            valueFile: values-account-only.yaml
          - release: banking-demo-transfer
            valueFile: values-transfer-only.yaml
          - release: banking-demo-notification
            valueFile: values-notification-only.yaml
          - release: banking-demo-frontend
            valueFile: values-frontend-only.yaml
          - release: banking-demo-ingress
            valueFile: values-ingress-only.yaml
  template:
    metadata:
      name: '{{release}}'
    spec:
      project: banking-demo
      source:
        repoURL: https://github.com/YOUR_ORG/banking-demo.git
        targetRevision: main
        path: phase2-helm-chart/banking-demo
        helm:
          releaseName: '{{release}}'
          valueFiles:
            - values.yaml
            - '{{valueFile}}'
      destination:
        server: https://kubernetes.default.svc
        namespace: banking
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
