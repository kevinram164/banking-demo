# ConfigMap — Banking Services Dashboard (Phase 5)
# Grafana sidecar (kube-prometheus-stack) tìm ConfigMaps có label grafana_dashboard="1"
# và tự động load vào Grafana. Apply vào namespace monitoring.
#
# Phase 5: auth, account, transfer, notification expose HTTP trực tiếp (ports 8001-8004).
# Prometheus scrape từng service; Kong route /api/* tới các service.
# Apply: kubectl apply -f grafana-dashboard-banking-services.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-banking-services
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  banking-services.json: |
    {"annotations":{"list":[]},"editable":true,"fiscalYearStartMonth":0,"graphTooltip":1,"id":null,"links":[],"liveNow":false,"panels":[{"id":1,"type":"timeseries","title":"Request Rate (RPS) by Service","gridPos":{"x":0,"y":0,"w":12,"h":8},"targets":[{"expr":"sum(rate(http_requests_total{job=~\"auth-service|account-service|transfer-service|notification-service\"}[1m])) by (job)","legendFormat":"{{job}}","refId":"A"}],"fieldConfig":{"defaults":{"unit":"reqps"}},"options":{}},{"id":2,"type":"timeseries","title":"P95 Latency by Service (seconds)","gridPos":{"x":12,"y":0,"w":12,"h":8},"targets":[{"expr":"histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job=~\"auth-service|account-service|transfer-service|notification-service\"}[1m])) by (job, le))","legendFormat":"{{job}} p95","refId":"A"}],"fieldConfig":{"defaults":{"unit":"s"}},"options":{}},{"id":3,"type":"timeseries","title":"Error Rate (5xx) by Service","gridPos":{"x":0,"y":8,"w":12,"h":8},"targets":[{"expr":"sum(rate(http_requests_total{job=~\"auth-service|account-service|transfer-service|notification-service\",status=~\"5..\"}[1m])) by (job) / sum(rate(http_requests_total{job=~\"auth-service|account-service|transfer-service|notification-service\"}[1m])) by (job) * 100","legendFormat":"{{job}} %","refId":"A"}],"fieldConfig":{"defaults":{"unit":"percent","min":0,"max":100}},"options":{}},{"id":4,"type":"stat","title":"Auth Service — Total Requests","gridPos":{"x":0,"y":16,"w":6,"h":4},"targets":[{"expr":"sum(http_requests_total{job=\"auth-service\"})","refId":"A"}],"fieldConfig":{"defaults":{"unit":"short"}},"options":{}},{"id":5,"type":"stat","title":"Account Service — Total Requests","gridPos":{"x":6,"y":16,"w":6,"h":4},"targets":[{"expr":"sum(http_requests_total{job=\"account-service\"})","refId":"A"}],"fieldConfig":{"defaults":{"unit":"short"}},"options":{}},{"id":6,"type":"stat","title":"Transfer Service — Total Requests","gridPos":{"x":12,"y":16,"w":6,"h":4},"targets":[{"expr":"sum(http_requests_total{job=\"transfer-service\"})","refId":"A"}],"fieldConfig":{"defaults":{"unit":"short"}},"options":{}},{"id":7,"type":"stat","title":"Notification Service — Total Requests","gridPos":{"x":18,"y":16,"w":6,"h":4},"targets":[{"expr":"sum(http_requests_total{job=\"notification-service\"})","refId":"A"}],"fieldConfig":{"defaults":{"unit":"short"}},"options":{}},{"id":8,"type":"timeseries","title":"Request Rate by Endpoint (Auth)","gridPos":{"x":0,"y":20,"w":12,"h":8},"targets":[{"expr":"sum(rate(http_requests_total{job=\"auth-service\"}[1m])) by (endpoint)","legendFormat":"{{endpoint}}","refId":"A"}],"fieldConfig":{"defaults":{"unit":"reqps"}},"options":{}},{"id":9,"type":"timeseries","title":"Request Rate by Status Code","gridPos":{"x":12,"y":20,"w":12,"h":8},"targets":[{"expr":"sum(rate(http_requests_total{job=~\"auth-service|account-service|transfer-service|notification-service\"}[1m])) by (job, status)","legendFormat":"{{job}} {{status}}","refId":"A"}],"fieldConfig":{"defaults":{"unit":"reqps"}},"options":{}},{"id":10,"type":"timeseries","title":"Transfer — Giao dịch thành công vs thất bại (RPS)","gridPos":{"x":0,"y":28,"w":8,"h":8},"targets":[{"expr":"sum(rate(http_requests_total{job=\"transfer-service\",endpoint=\"/transfer\",status=~\"2..\"}[1m]))","legendFormat":"Thành công (2xx)","refId":"A"},{"expr":"sum(rate(http_requests_total{job=\"transfer-service\",endpoint=\"/transfer\",status=~\"4..\"}[1m]))","legendFormat":"Thất bại (4xx)","refId":"B"},{"expr":"sum(rate(http_requests_total{job=\"transfer-service\",endpoint=\"/transfer\",status=~\"5..\"}[1m]))","legendFormat":"Lỗi server (5xx)","refId":"C"}],"fieldConfig":{"defaults":{"unit":"reqps"}},"options":{}},{"id":13,"type":"stat","title":"Transfer — Tổng giao dịch","gridPos":{"x":8,"y":28,"w":4,"h":4},"targets":[{"expr":"sum(http_requests_total{job=\"transfer-service\",endpoint=\"/transfer\"})","refId":"A"}],"fieldConfig":{"defaults":{"unit":"short","thresholds":{"mode":"absolute","steps":[{"color":"blue","value":null}]}}},"options":{}},{"id":14,"type":"stat","title":"Transfer — Thành công","gridPos":{"x":8,"y":32,"w":4,"h":4},"targets":[{"expr":"sum(http_requests_total{job=\"transfer-service\",endpoint=\"/transfer\",status=~\"2..\"})","refId":"A"}],"fieldConfig":{"defaults":{"unit":"short","thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]}}},"options":{}},{"id":11,"type":"gauge","title":"Transfer — Tỷ lệ thành công (%)","description":"Tính trên tổng số request kể từ khi pod start","gridPos":{"x":12,"y":28,"w":6,"h":8},"targets":[{"expr":"sum(http_requests_total{job=\"transfer-service\",endpoint=\"/transfer\",status=~\"2..\"}) / sum(http_requests_total{job=\"transfer-service\",endpoint=\"/transfer\"}) * 100","refId":"A"}],"fieldConfig":{"defaults":{"unit":"percent","min":0,"max":100,"noValue":"N/A","thresholds":{"mode":"absolute","steps":[{"color":"red","value":null},{"color":"yellow","value":95},{"color":"green","value":99}]}}},"options":{}},{"id":12,"type":"gauge","title":"Transfer — Tỷ lệ thất bại (%)","description":"Tính trên tổng số request kể từ khi pod start","gridPos":{"x":18,"y":28,"w":6,"h":8},"targets":[{"expr":"sum(http_requests_total{job=\"transfer-service\",endpoint=\"/transfer\",status=~\"[45]..\"}) / sum(http_requests_total{job=\"transfer-service\",endpoint=\"/transfer\"}) * 100","refId":"A"}],"fieldConfig":{"defaults":{"unit":"percent","min":0,"max":100,"noValue":"N/A","thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":1},{"color":"red","value":5}]}}},"options":{}}],"refresh":"10s","schemaVersion":38,"tags":["banking","services"],"templating":{"list":[]},"time":{"from":"now-30m","to":"now"},"timepicker":{},"timezone":"","title":"Banking Services","uid":"banking-services","version":2,"weekStart":""}
